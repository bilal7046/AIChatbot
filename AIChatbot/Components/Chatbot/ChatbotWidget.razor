@using AIChatbot.Services
@using Microsoft.JSInterop
@inject ChatService ChatService
@inject DocumentService DocumentService
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable
@rendermode InteractiveServer

<style>
    .jmm-widget-container {
        position: fixed;
        z-index: 10000;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    }

        .jmm-widget-container.position-bottom-right {
            bottom: 20px;
            right: 20px;
        }

        .jmm-widget-container.position-bottom-left {
            bottom: 20px;
            left: 20px;
        }

        .jmm-widget-container.position-top-right {
            top: 20px;
            right: 20px;
        }

        .jmm-widget-container.position-top-left {
            top: 20px;
            left: 20px;
        }

    .jmm-widget-button {
        width: 64px;
        height: 64px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: none;
        position: relative;
        overflow: hidden;
    }

        .jmm-widget-button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .jmm-widget-button:hover {
            transform: scale(1.08) translateY(-2px);
            box-shadow: 0 12px 32px rgba(102, 126, 234, 0.5);
        }

        .jmm-widget-button:hover::before {
            width: 300px;
            height: 300px;
        }

        .jmm-widget-button:active {
            transform: scale(0.95);
        }

    .jmm-widget-chat {
        position: absolute;
        bottom: 80px;
        right: 0;
        width: 400px;
        height: 650px;
        background: white;
        border-radius: 24px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(0, 0, 0, 0.05);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @@keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(20px) scale(0.95);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    .position-bottom-left .jmm-widget-chat {
        right: auto;
        left: 0;
    }

    .position-top-right .jmm-widget-chat {
        bottom: auto;
        top: 80px;
    }

    .position-top-left .jmm-widget-chat {
        bottom: auto;
        top: 80px;
        right: auto;
        left: 0;
    }

    .jmm-widget-header {
        color: white;
        padding: 20px 24px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

        .jmm-widget-header h3 {
            margin: 0;
            font-size: 20px;
            font-weight: 700;
            letter-spacing: -0.5px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

    .jmm-widget-close {
        background: none;
        border: none;
        color: white;
        font-size: 28px;
        cursor: pointer;
        padding: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: background 0.2s;
    }

        .jmm-widget-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

    .jmm-back-button {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        font-size: 20px;
        cursor: pointer;
        padding: 4px 8px;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: background 0.2s;
    }

        .jmm-back-button:hover {
            background: rgba(255, 255, 255, 0.3);
        }

    .jmm-widget-messages {
        flex: 1;
        overflow-y: auto;
        padding: 24px;
        background: linear-gradient(to bottom, #f8f9fa 0%, #ffffff 100%);
        scroll-behavior: smooth;
    }

        .jmm-widget-messages::-webkit-scrollbar {
            width: 6px;
        }

        .jmm-widget-messages::-webkit-scrollbar-track {
            background: transparent;
        }

        .jmm-widget-messages::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 3px;
        }

        .jmm-widget-messages::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.3);
        }

    .jmm-message {
        margin-bottom: 20px;
        display: flex;
        animation: messageSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @@keyframes messageSlideIn {
        from {
            opacity: 0;
            transform: translateY(15px) scale(0.95);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    .jmm-message-user {
        justify-content: flex-end;
    }

    .jmm-message-bot {
        justify-content: flex-start;
    }

    .jmm-message-content {
        max-width: 80%;
        padding: 14px 18px;
        border-radius: 20px;
        word-wrap: break-word;
        line-height: 1.5;
        font-size: 15px;
        position: relative;
    }

    .jmm-message-user .jmm-message-content {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-bottom-right-radius: 6px;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .jmm-message-bot .jmm-message-content {
        background: white;
        color: #2d3748;
        border-bottom-left-radius: 6px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .jmm-widget-input-container {
        padding: 20px;
        background: white;
        border-top: 1px solid rgba(0, 0, 0, 0.08);
        display: flex;
        gap: 10px;
        align-items: flex-end;
        box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.05);
    }

    .jmm-input-wrapper {
        flex: 1;
        display: flex;
        align-items: center;
        border: 2px solid #e2e8f0;
        border-radius: 28px;
        padding: 10px 16px;
        background: #f7fafc;
        transition: all 0.3s;
    }

        .jmm-input-wrapper:focus-within {
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

    .jmm-widget-input {
        flex: 1;
        border: none;
        outline: none;
        background: transparent;
        font-size: 14px;
        padding: 4px 8px;
    }

    .jmm-voice-button {
        background: none;
        border: none;
        color: #667eea;
        cursor: pointer;
        padding: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        width: 36px;
        height: 36px;
    }

        .jmm-voice-button:hover {
            background: rgba(102, 126, 234, 0.1);
            transform: scale(1.1);
        }

        .jmm-voice-button.active {
            background: rgba(220, 53, 69, 0.15);
            color: #dc3545;
            animation: voicePulse 1.5s ease-in-out infinite;
        }

    @@keyframes voicePulse {
        0%, 100% {
            transform: scale(1);
            box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.4);
        }
        50% {
            transform: scale(1.1);
            box-shadow: 0 0 0 8px rgba(220, 53, 69, 0);
        }
    }

    .jmm-send-button {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        color: white;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

        .jmm-send-button:hover {
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
        }

        .jmm-send-button:active {
            transform: scale(0.95);
        }

    .jmm-listening-indicator {
        padding: 16px 20px;
        background: linear-gradient(135deg, #fff5e6 0%, #ffe6cc 100%);
        border-top: 1px solid #ffc107;
        display: flex;
        align-items: center;
        gap: 12px;
        color: #856404;
        font-size: 14px;
        font-weight: 500;
        animation: pulseBackground 2s ease-in-out infinite;
    }

    @@keyframes pulseBackground {
        0%, 100% {
            background: linear-gradient(135deg, #fff5e6 0%, #ffe6cc 100%);
        }
        50% {
            background: linear-gradient(135deg, #ffe6cc 0%, #ffd9b3 100%);
        }
    }

    .jmm-pulse {
        width: 14px;
        height: 14px;
        background: #dc3545;
        border-radius: 50%;
        animation: pulse 1.5s ease-in-out infinite;
        box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7);
    }

    @@keyframes pulse {
        0% {
            opacity: 1;
            transform: scale(1);
            box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7);
        }
        50% {
            opacity: 0.8;
            transform: scale(1.2);
            box-shadow: 0 0 0 4px rgba(220, 53, 69, 0);
        }
        100% {
            opacity: 1;
            transform: scale(1);
            box-shadow: 0 0 0 0 rgba(220, 53, 69, 0);
        }
    }

    .jmm-service-options {
        display: flex;
        flex-direction: column;
        gap: 12px;
        padding: 16px 20px;
    }

    .jmm-back-to-menu-button-container {
        padding: 0 20px 12px 20px;
    }

    .jmm-back-to-menu-button {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px 20px;
        border: 2px solid;
        border-radius: 24px;
        background: transparent;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        width: 100%;
        justify-content: center;
    }

        .jmm-back-to-menu-button:hover {
            background: rgba(102, 126, 234, 0.1);
            transform: translateX(-4px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .jmm-back-to-menu-button:active {
            transform: translateX(-2px);
        }

    .jmm-service-button {
        display: flex;
        align-items: center;
        gap: 14px;
        padding: 18px 22px;
        border: none;
        border-radius: 16px;
        color: white;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        text-align: left;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        position: relative;
        overflow: hidden;
    }

        .jmm-service-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .jmm-service-button:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }

        .jmm-service-button:hover::before {
            left: 100%;
        }

        .jmm-service-button:active {
            transform: translateY(-1px) scale(0.98);
        }

        .jmm-service-button:active {
            transform: translateY(0);
        }

        .jmm-service-button svg {
            flex-shrink: 0;
        }

    .jmm-typing-indicator {
        display: flex;
        gap: 4px;
        padding: 8px 0;
    }

        .jmm-typing-indicator span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #999;
            animation: typing 1.4s infinite;
        }

            .jmm-typing-indicator span:nth-child(2) {
                animation-delay: 0.2s;
            }

            .jmm-typing-indicator span:nth-child(3) {
                animation-delay: 0.4s;
            }

    @@keyframes typing {
        0%, 60%, 100% {
            transform: translateY(0);
            opacity: 0.7;
        }

        30% {
            transform: translateY(-10px);
            opacity: 1;
        }
    }

    .jmm-send-button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    @@media (max-width: 480px) {
        .jmm-widget-chat {
            width: calc(100vw - 40px);
            height: calc(100vh - 100px);
            bottom: 80px;
            right: 20px;
            left: 20px;
        }

        .jmm-service-button {
            font-size: 14px;
            padding: 12px 16px;
        }
    }

</style>
<div class="jmm-widget-container @PositionClass">
    <div class="jmm-widget-button" @onclick="ToggleChat" style="display: @(IsOpen ? "none" : "flex"); background: @PrimaryColor">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
        </svg>
    </div>
    
    <div class="jmm-widget-chat" style="display: @(IsOpen ? "flex" : "none")">
        <div class="jmm-widget-header" style="background: @PrimaryColor">
            <div style="display: flex; align-items: center; gap: 12px;">
                @if (CategorySelected)
                {
                    <button class="jmm-back-button" @onclick="BackToMenu" title="Back to main menu">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M19 12H5M12 19l-7-7 7-7"/>
                        </svg>
                    </button>
                }
                <h3>AI Assistant</h3>
            </div>
            <button class="jmm-widget-close" @onclick="ToggleChat">Ã—</button>
        </div>
        
        <div class="jmm-widget-messages" @ref="messagesContainer">
            @if (!CategorySelected)
            {
                <div class="jmm-message jmm-message-bot">
                    <div class="jmm-message-content">
                        <strong>Welcome! I'm your AI assistant.</strong><br/>
                        Please select a service you'd like help with:
                    </div>
                </div>
                
                <div class="jmm-service-options">
                    <button class="jmm-service-button" @onclick="@(() => SelectCategory("Navigation Guidance"))" style="background: @PrimaryColor">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                            <circle cx="12" cy="10" r="3"></circle>
                        </svg>
                        <span>Navigation Guidance</span>
                    </button>
                    <button class="jmm-service-button" @onclick="@(() => SelectCategory("Service Explanation"))" style="background: @PrimaryColor">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="16" x2="12" y2="12"></line>
                            <line x1="12" y1="8" x2="12.01" y2="8"></line>
                        </svg>
                        <span>Service Explanation</span>
                    </button>
                    <button class="jmm-service-button" @onclick="@(() => SelectCategory("Status Inquiries"))" style="background: @PrimaryColor">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                        </svg>
                        <span>Status Inquiries</span>
                    </button>
                </div>
            }
            else
            {
                <div class="jmm-message jmm-message-bot">
                    <div class="jmm-message-content">
                        <strong>@SelectedCategory</strong><br/>
                        How can I help you with @SelectedCategory?.ToLower()? Ask me any questions!
                    </div>
                </div>
                
                <div class="jmm-back-to-menu-button-container">
                    <button class="jmm-back-to-menu-button" @onclick="BackToMenu" style="border-color: @PrimaryColor; color: @PrimaryColor">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M19 12H5M12 19l-7-7 7-7"/>
                        </svg>
                        <span>Back to Main Menu</span>
                    </button>
                </div>
            }
            
            @foreach (var message in Messages)
            {
                <div class="jmm-message jmm-message-@(message.IsUser ? "user" : "bot")">
                    <div class="jmm-message-content" style="@(message.IsUser ? $"background: {PrimaryColor};" : "")">@message.Text</div>
                </div>
            }
            
            @if (IsLoading)
            {
                <div class="jmm-message jmm-message-bot">
                    <div class="jmm-message-content">
                        <div class="jmm-typing-indicator">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </div>
                </div>
            }
        </div>
        
        @if (CategorySelected)
        {
            <div class="jmm-widget-input-container">
                <div class="jmm-input-wrapper">
                    <input type="text" 
                           @bind="inputText" 
                           @bind:event="oninput"
                           @onkeypress="HandleKeyPress"
                           class="jmm-widget-input" 
                           placeholder="Ask about @SelectedCategory..."
                           autocomplete="off" />
                    <button class="jmm-voice-button @(IsListening ? "active" : "")" 
                            @onmousedown="StartListening"
                            @onmouseup="StopListening"
                            @onmouseleave="StopListening"
                            @ontouchstart="StartListening"
                            @ontouchend="StopListening"
                            style="color: @PrimaryColor"
                            title="Press and hold to speak">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"></path>
                            <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"></path>
                        </svg>
                    </button>
                </div>
                <button class="jmm-send-button" @onclick="SendMessage" style="background: @PrimaryColor" disabled="@IsLoading">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                </button>
            </div>
        }
        
        <div class="jmm-listening-indicator" style="display: @(IsListening ? "flex" : "none")">
            <div class="jmm-pulse"></div>
            <span>Listening...</span>
        </div>
    </div>
</div>

@code {
    [Parameter] public string Position { get; set; } = "bottom-right";
    [Parameter] public string PrimaryColor { get; set; } = "#007bff";
    [Parameter] public string? DocumentPath { get; set; }

    private bool IsOpen { get; set; } = false;
    private bool IsListening { get; set; } = false;
    private bool IsLoading { get; set; } = false;
    private bool CategorySelected { get; set; } = false;
    private string? SelectedCategory { get; set; }
    private string inputText = string.Empty;
    private List<AIChatbot.Services.ChatMessage> Messages { get; set; } = new();
    private ElementReference messagesContainer;
    private IJSObjectReference? speechModule;
    private DotNetObjectReference<ChatbotWidget>? dotNetRef;

    private string PositionClass => Position switch
    {
        "bottom-left" => "position-bottom-left",
        "top-right" => "position-top-right",
        "top-left" => "position-top-left",
        _ => "position-bottom-right"
    };

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                speechModule = await JSRuntime.InvokeAsync<IJSObjectReference>("import", "./js/speech-recognition.js");
                dotNetRef = DotNetObjectReference.Create(this);
                await speechModule.InvokeVoidAsync("initialize", dotNetRef);
                
                // Load document if path is provided
                if (!string.IsNullOrWhiteSpace(DocumentPath))
                {
                    await DocumentService.LoadDocumentFromFileAsync(DocumentPath);
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error initializing: {ex.Message}");
                // Document loading is optional, continue without it
            }
        }

        if (IsOpen)
        {
            await ScrollToBottom();
        }
    }

    private void ToggleChat()
    {
        IsOpen = !IsOpen;
        if (IsOpen)
        {
            // Reset to show options if chat is reopened
            if (!CategorySelected)
            {
                Messages.Clear();
            }
            StateHasChanged();
        }
    }

    private void BackToMenu()
    {
        CategorySelected = false;
        SelectedCategory = null;
        Messages.Clear();
        inputText = string.Empty;
        IsListening = false;
        IsLoading = false;
        StateHasChanged();
    }

    private async Task SelectCategory(string category)
    {
        SelectedCategory = category;
        CategorySelected = true;
        StateHasChanged();
        await ScrollToBottom();

        // Show a simple, sweet welcome message based on category
        string welcomeMessage = category switch
        {
            "Navigation Guidance" => "Hi! I'm here to help you find us! ðŸ—ºï¸\n\nI can help you with directions, our location, office hours, and how to get here. What would you like to know?",
            "Service Explanation" => "Hello! I'd love to tell you about our services! ðŸ’¼\n\nI can explain what we offer, our capabilities, and how we can help your business. What interests you?",
            "Status Inquiries" => "Hey there! I can help you check on your request! ðŸ“Š\n\nI can tell you how to track your order, check status updates, and find out processing times. What do you need?",
            _ => $"I'm ready to help you with {category}! What would you like to know?"
        };

        Messages.Add(new AIChatbot.Services.ChatMessage { IsUser = false, Text = welcomeMessage });
        StateHasChanged();
        await ScrollToBottom();
    }

    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !IsLoading)
        {
            await SendMessage();
        }
    }

    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(inputText) || IsLoading || !CategorySelected)
            return;

        var userMessage = inputText.Trim();
        inputText = string.Empty;
        
        Messages.Add(new AIChatbot.Services.ChatMessage { IsUser = true, Text = userMessage });
        IsLoading = true;
        StateHasChanged();
        await ScrollToBottom();

        try
        {
            var response = await ChatService.ProcessMessageAsync(userMessage, Messages, SelectedCategory);
            Messages.Add(new AIChatbot.Services.ChatMessage { IsUser = false, Text = response });
        }
        catch
        {
            Messages.Add(new AIChatbot.Services.ChatMessage { IsUser = false, Text = "I apologize, but I'm having trouble processing your request. Please try again." });
        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
            await ScrollToBottom();
        }
    }

    private async Task StartListening()
    {
        if (speechModule == null)
        {
            Messages.Add(new AIChatbot.Services.ChatMessage { IsUser = false, Text = "Voice input is not available. Please use Chrome, Edge, or Safari browser." });
            StateHasChanged();
            return;
        }

        if (!CategorySelected)
        {
            return;
        }

        if (!IsOpen)
        {
            ToggleChat();
        }

        try
        {
            IsListening = true;
            StateHasChanged();
            await speechModule.InvokeVoidAsync("startListening");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error starting speech recognition: {ex.Message}");
            IsListening = false;
            Messages.Add(new AIChatbot.Services.ChatMessage { IsUser = false, Text = "Could not start voice input. Please try again." });
            StateHasChanged();
        }
    }

    private async Task StopListening()
    {
        if (speechModule == null) return;

        try
        {
            IsListening = false;
            StateHasChanged();
            await speechModule.InvokeVoidAsync("stopListening");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error stopping speech recognition: {ex.Message}");
        }
    }

    [JSInvokable]
    public async Task OnSpeechResult(string transcript)
    {
        if (!string.IsNullOrWhiteSpace(transcript))
        {
            inputText = transcript;
            await SendMessage();
        }
        IsListening = false;
        StateHasChanged();
    }

    [JSInvokable]
    public void OnSpeechError(string error)
    {
        IsListening = false;
        StateHasChanged();
        
        // Don't show error for these cases
        if (error == "no-speech" || error == "aborted")
        {
            return;
        }
        
        // Show user-friendly error messages
        string errorMessage = error switch
        {
            "not-allowed" => "Microphone permission denied. Please allow microphone access in your browser settings.",
            "not-available" => "Speech recognition is not available in your browser. Please use Chrome, Edge, or Safari.",
            "start-failed" => "Could not start voice input. Please try again.",
            _ => "I didn't catch that. Please try again."
        };
        
        Messages.Add(new AIChatbot.Services.ChatMessage { IsUser = false, Text = errorMessage });
        StateHasChanged();
    }

    [JSInvokable]
    public void OnSpeechEnd()
    {
        // Speech recognition ended (user released button or recognition stopped)
        IsListening = false;
        StateHasChanged();
    }

    private async Task ScrollToBottom()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("scrollToBottom", messagesContainer);
        }
        catch { }
    }

    public async ValueTask DisposeAsync()
    {
        if (speechModule != null)
        {
            try
            {
                await speechModule.InvokeVoidAsync("dispose");
                await speechModule.DisposeAsync();
            }
            catch { }
        }
        dotNetRef?.Dispose();
    }
}
